<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <title>ESAR Photo Albums</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      background: #fff;
      color: #202124;
    }

    /* ── Filter / search bar ─────────────────────────────────────────────── */
    .filters {
      display: flex;
      gap: 10px;
      padding: 14px 20px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      flex-wrap: wrap;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .search-wrap {
      position: relative;
      flex: 1;
      min-width: 180px;
    }
    .search-wrap .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #5f6368;
      pointer-events: none;
    }
    .filters input[type="search"] {
      width: 100%;
      padding: 8px 12px 8px 34px;
      border: 1px solid #dadce0;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      font-family: inherit;
      transition: border-color .15s, box-shadow .15s;
    }
    .filters input[type="search"]:focus {
      border-color: #2d6a2d;
      box-shadow: 0 0 0 2px rgba(45,106,45,.15);
    }
    .filters select {
      padding: 8px 14px;
      border: 1px solid #dadce0;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      cursor: pointer;
      background: #fff;
      font-family: inherit;
      transition: border-color .15s;
    }
    .filters select:focus { border-color: #2d6a2d; }
    #results-count {
      font-size: 13px;
      color: #5f6368;
      white-space: nowrap;
    }

    /* ── Card grid ───────────────────────────────────────────────────────── */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
      padding: 20px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.06);
      transition: box-shadow .2s, transform .2s;
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
    }
    .card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,.18);
      transform: translateY(-2px);
    }
    .card-thumb {
      width: 100%;
      height: 180px;
      position: relative;
      background: #dde8dd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      flex-shrink: 0;
    }
    .card-thumb img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .card-body {
      padding: 14px 16px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
      line-height: 1.4;
    }
    .card-date {
      font-size: 11px;
      color: #5f6368;
      margin-bottom: 8px;
    }
    .card-desc {
      font-size: 13px;
      color: #3c4043;
      line-height: 1.5;
      flex: 1;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .card-cta {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      font-weight: 500;
      color: #2d6a2d;
      background: #e8f5e9;
      border-radius: 20px;
      padding: 6px 14px;
      align-self: flex-start;
      transition: background .15s;
    }
    .card:hover .card-cta { background: #c8e6c9; }

    /* ── States ──────────────────────────────────────────────────────────── */
    .center {
      text-align: center;
      padding: 60px 20px;
      color: #80868b;
      grid-column: 1 / -1;
    }
    .spinner {
      display: inline-block;
      width: 32px; height: 32px;
      border: 3px solid #e8eaed;
      border-top-color: #2d6a2d;
      border-radius: 50%;
      animation: spin .8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .center p { font-size: 14px; margin-top: 6px; }
  </style>
</head>
<body>

<!-- Sticky search + year filter — no duplicate page title here -->
<div class="filters">
  <div class="search-wrap">
    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </svg>
    <input type="search" id="search" placeholder="Search by title or description…" oninput="filter()">
  </div>
  <select id="year-filter" onchange="filter()">
    <option value="">All years</option>
  </select>
  <span id="results-count"></span>
</div>

<div id="grid" class="grid">
  <div class="center">
    <div class="spinner"></div>
    <p>Loading albums&hellip;</p>
  </div>
</div>

<script>
  var ALL_ALBUMS = [];

  google.script.run
    .withSuccessHandler(function(result) {
      var grid = document.getElementById('grid');
      if (!result.success) {
        grid.innerHTML = '<div class="center"><p>Could not load albums: ' + esc(result.error) + '</p></div>';
        return;
      }
      if (!result.albums.length) {
        grid.innerHTML = '<div class="center"><p style="font-size:32px">&#128193;</p><p>No albums yet.</p></div>';
        return;
      }

      ALL_ALBUMS = result.albums;

      // Populate year dropdown from dates present in the data.
      var years = {};
      ALL_ALBUMS.forEach(function(a) {
        var m = (a.dateAdded || '').match(/\b(20\d\d)\b/);
        if (m) years[m[1]] = true;
      });
      var yearSel = document.getElementById('year-filter');
      Object.keys(years).sort().reverse().forEach(function(y) {
        var opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSel.appendChild(opt);
      });

      filter();
    })
    .withFailureHandler(function(e) {
      document.getElementById('grid').innerHTML =
        '<div class="center"><p>Could not load albums: ' + esc(e.message) + '</p></div>';
    })
    .serverGetAlbums();

  function filter() {
    var q    = document.getElementById('search').value.toLowerCase();
    var year = document.getElementById('year-filter').value;

    var shown = ALL_ALBUMS.filter(function(a) {
      var matchText = !q ||
        a.title.toLowerCase().indexOf(q) !== -1 ||
        (a.description || '').toLowerCase().indexOf(q) !== -1;
      var matchYear = !year || (a.dateAdded && a.dateAdded.indexOf(year) !== -1);
      return matchText && matchYear;
    });

    var countEl = document.getElementById('results-count');
    countEl.textContent = shown.length === ALL_ALBUMS.length
      ? ALL_ALBUMS.length + ' album' + (ALL_ALBUMS.length === 1 ? '' : 's')
      : shown.length + ' of ' + ALL_ALBUMS.length + ' albums';

    var grid = document.getElementById('grid');
    if (!shown.length) {
      grid.innerHTML = '<div class="center"><p>No albums match your search.</p></div>';
      return;
    }

    grid.innerHTML = shown.map(function(a) {
      var href = a.photosUrl ? esc(a.photosUrl) : '#';
      var desc = a.description
        ? '<div class="card-desc">' + esc(a.description) + '</div>'
        : '';
      return (
        '<a class="card" href="' + href + '" target="_blank" rel="noopener noreferrer">' +
          '<div class="card-thumb">&#128247;' +
            (a.thumbnail ? '<img src="' + esc(a.thumbnail) + '" alt="' + esc(a.title) + '" loading="lazy" onerror="this.remove()">' : '') +
          '</div>' +
          '<div class="card-body">' +
            '<div class="card-title">' + esc(a.title) + '</div>' +
            '<div class="card-date">' + esc(a.dateAdded) + '</div>' +
            desc +
            '<span class="card-cta">&#128247;&thinsp; View Album</span>' +
          '</div>' +
        '</a>'
      );
    }).join('');
  }

  function esc(s) {
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(String(s || '')));
    return d.innerHTML;
  }
</script>
</body>
</html>
